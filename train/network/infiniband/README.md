
## 运行一个 ib perf 测试


### 使用 ib_send_bw 测试节点之间的 ib 网络

我们通过 yaml 文件定义了一个 pytorchjob，它会启动 master 和 worker 各一个节点，并运行 ib_send_bw 测试。

```bash
# Usage
# 将我们要运行的脚本 submit-job.sh 注册为一个 configmap，方便后续使用
make script

# 提交任务
make submit

# 查看日志 kubectl logs <pod-name>
kubectl logs kubeflow-ib-perftest-1-master-0
```


典型输出如下：
```
================================================
============ ib devices ========================
================================================

available ib devices:
mlx5_0
mlx5_1
mlx5_2
mlx5_3
mlx5_6
mlx5_7
mlx5_8
mlx5_9
selected ib device: mlx5_7, rate: 200 Gb/s

================================================
============ ib bandwidth test =================
================================================

master node, start ib_send_bw server side ...
 WARNING: BW peak won't be measured in this run.

************************************
* Waiting for client to connect... *
************************************
---------------------------------------------------------------------------------------
                    Send BW Test
 Dual-port       : OFF          Device         : mlx5_7
 Number of qps   : 1            Transport type : IB
 Connection type : RC           Using SRQ      : OFF
 PCIe relax order: ON
 ibv_wr* API     : ON
 RX depth        : 512
 CQ Moderation   : 100
 Mtu             : 4096[B]
 Link type       : IB
 Max inline data : 0[B]
 rdma_cm QPs     : OFF
 Data ex. method : Ethernet
---------------------------------------------------------------------------------------
 local address: LID 0x14d QPN 0x0028 PSN 0x63860b
 remote address: LID 0x154 QPN 0x0027 PSN 0x63860b
---------------------------------------------------------------------------------------
 #bytes     #iterations    BW peak[Gb/sec]    BW average[Gb/sec]   MsgRate[Mpps]
 2          1000           0.000000            0.080455            5.028415
 4          1000             0.00               0.16                 5.138466
 8          1000             0.00               0.33                 5.182441
 16         1000             0.00               0.65                 5.067960
 32         1000             0.00               1.32                 5.138267
 64         1000             0.00               2.66                 5.197984
 128        1000             0.00               5.32                 5.197965
 256        1000             0.00               10.62                5.186488
 512        1000             0.00               21.25                5.186848
 1024       1000             0.00               42.11                5.139976
 2048       1000             0.00               81.85                4.995615
 4096       1000             0.00               135.61               4.138616
 8192       1000             0.00               194.40               2.966323
 16384      1000             0.00               197.80               1.509061
 32768      1000             0.00               197.76               0.754385
 65536      1000             0.00               197.77               0.377218
 131072     1000             0.00               197.76               0.188596
 262144     1000             0.00               197.75               0.094296
 524288     1000             0.00               197.77               0.047152
 1048576    1000             0.00               197.77               0.023576
 2097152    1000             0.00               197.75               0.011787
 4194304    1000             0.00               197.77               0.005894
 8388608    1000             0.00               197.75               0.002947
---------------------------------------------------------------------------------------
```

